<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Assistant Chatbot</title>
    <link rel="stylesheet" href="/static/chatbot.css">
</head>
<body>
    <h1>Medical Assistant Chatbot</h1>

    <button onclick="window.location.href='/'">Back to Main Page</button>

    <div id="chat-container">
        <div id="messages"></div> <!-- Chat messages will be appended here -->

        <!-- Text Input Form -->
        <h3>Text Input</h3>
        <form id="text-form">
            <textarea id="text-input" name="query" placeholder="Type your message here..." rows="3"></textarea>
            <button type="submit">Submit Text</button>
        </form>

        <!-- File Upload Form -->
        <h3>File Upload (PDF/DOCX)</h3>
        <form id="file-form" action="/process_document" method="post" enctype="multipart/form-data">
            <input type="file" id="file-input" name="file" accept=".pdf,.docx">
            <button type="submit">Submit File</button>
        </form>

        <!-- Voice Upload Form -->
        <h3>Voice Input (Audio File)</h3>
        <form id="audio-form" action="/process_voice" method="post" enctype="multipart/form-data">
            <input type="file" id="audio-input" name="file" accept=".mp3,.wav">
            <button type="submit">Submit Audio</button>
        </form>
    </div>

    <script>
        // Function to append messages to the chatbox
        function appendMessage(message, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add(sender);  // Add 'user' or 'assistant' class based on the sender
            messageDiv.textContent = message;
            document.getElementById('messages').appendChild(messageDiv);
            // Scroll to the bottom of the chatbox after new message
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        }

        // Load initial message and response passed from the backend
        const initialMessage = "{{ content|e }}";  // User's initial message
        const initialResponse = "{{ response|e }}";  // Bot's response (same as initial message for now)

        // Append the initial message and response to the chatbox
        if (initialMessage) {
            appendMessage(initialMessage, 'user');  // Append the user's message
        }
        if (initialResponse) {
            appendMessage(initialResponse, 'assistant');  // Append the bot's response
        }
        
        // Handle form submission for text input
        document.getElementById('text-form').addEventListener('submit', async function(event) {
            event.preventDefault();  // Prevent the form from submitting the traditional way

            const userMessage = document.getElementById('text-input').value;
            if (userMessage.trim() === "") return;  // Don't submit empty messages

            // Append user's message to the chatbox
            appendMessage(userMessage, 'user');

            // Clear the input field
            document.getElementById('text-input').value = '';

            // Send the message to the backend to get the response
            try {
                const response = await fetch('/ask_model', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'query': userMessage  // Ensure 'query' is the correct field name
                    })
                });

                if (response.ok) {
                    const data = await response.json();  // Extract JSON from the response
                    const botMessage = data.response;    // Get the 'response' field from the JSON
                    appendMessage(botMessage, 'assistant');  // Append bot's response to the chatbox
                } else {
                    appendMessage("Error processing your request", 'assistant');
                }
            } catch (error) {
                appendMessage("Network error occurred", 'assistant');
            }
        });
    </script>

</body>
</html>
